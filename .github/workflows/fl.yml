name: Build Optimized APK (arm64-v8a)

on:
  workflow_dispatch:        # 手动触发
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. 检出代码
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. 设置 Java 环境
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      # 3. 设置 Flutter（使用稳定版 3.38.10）
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.10'
          channel: 'stable'
          cache: true

      - name: Flutter doctor
        run: flutter doctor -v

      # 4. 创建 debug 密钥库（用于 release 签名）
      - name: Create debug keystore
        run: |
          mkdir -p ~/.android
          keytool -genkey -v -keystore ~/.android/debug.keystore \
            -alias androiddebugkey -keyalg RSA -keysize 2048 -validity 10000 \
            -dname "CN=Android Debug, O=Android, C=US" \
            -storepass android -keypass android

      # 5. 在 android 目录下创建 key.properties，指向刚刚生成的 debug keystore
      - name: Create key.properties
        working-directory: ./simple_live_app/android
        run: |
          cat > key.properties << EOF
          keyAlias=androiddebugkey
          keyPassword=android
          storeFile=/home/runner/.android/debug.keystore
          storePassword=android
          EOF
          echo "Created key.properties:"
          cat key.properties

      # 6. 获取依赖
      - name: Get dependencies
        working-directory: ./simple_live_app
        run: flutter pub get

      # 7. 构建 release APK（仅 arm64-v8a 架构，开启混淆以减小体积）
      - name: Build release APK
        working-directory: ./simple_live_app
        run: |
          flutter build apk --release \
            --target-platform android-arm64 \
            --obfuscate \
            --split-debug-info=build/debug-info

      # 8. 从 pubspec.yaml 中提取版本号（用于命名）
      - name: Get version
        id: version
        working-directory: ./simple_live_app
        run: |
          echo "VERSION=$(grep 'version:' pubspec.yaml | sed 's/version: //' | tr -d ' ')" >> $GITHUB_OUTPUT

      # 9. 上传 APK 作为 artifact
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: simple-live-arm64-v${{ steps.version.outputs.VERSION }}
          path: ./simple_live_app/build/app/outputs/flutter-apk/app-release.apk
          if-no-files-found: error
